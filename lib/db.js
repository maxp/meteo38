// Generated by CoffeeScript 1.10.0
(function() {
  var Grid, MongoClient, ObjectID, cli, config, db_conn, debug, info, make_oid, ref, ref1, str_id, warn, x;

  x = typeof exports !== "undefined" && exports !== null ? exports : this;

  config = require('./config');

  ref = require('./logger'), debug = ref.debug, info = ref.info, warn = ref.warn;

  ref1 = require('mongodb'), MongoClient = ref1.MongoClient, ObjectID = ref1.ObjectID, Grid = ref1.Grid;

  db_conn = null;

  cli = MongoClient.connect(config.db.url);

  cli.then(function(db) {
    info("db connected", db);
    return db_conn = db;
  });

  cli["catch"](function(err) {
    warn("db.err:", err);
    return process.exit(1);
  });

  x.OID = x.ObjectID = ObjectID;

  x.db_conn = function() {
    return db_conn;
  };

  x.coll = function(collection_name) {
    return db_conn.collection(collection_name);
  };

  x.make_oid = make_oid = function(id) {
    var err, error;
    try {
      return ObjectID(id);
    } catch (error) {
      err = error;
      return null;
    }
  };

  x.str_id = str_id = function(id) {
    var err, error;
    if (!id) {
      return null;
    }
    if (id instanceof ObjectID) {
      return id;
    }
    try {
      return ObjectID(id);
    } catch (error) {
      err = error;
      return "" + id;
    }
  };

  x.coll_dat = function() {
    return db_conn.collection("dat");
  };

  x.coll_st = function() {
    info("st", db_conn);
    return db_conn.collection("st");
  };

}).call(this);
